---
name: weekly-report
description: 自动读取 Git 提交记录生成周报。用于生成工作周报、项目总结、团队协作汇报。支持多仓库汇总。
allowed-tools: Read, Write, Bash(git:*), Bash(python:*)
metadata:
  author: adonis
  version: "1.0.0"
---

# 周报生成技能

自动读取 Git 提交记录，按项目分组生成结构化周报。

## 功能特性

- 自动读取 Git 提交记录
- 支持多仓库汇总
- 自动识别当前用户 (`git config user.name`)
- 按项目分组，生成结构化周报
- 过滤琐碎提交（typo、merge、format 等）
- 支持添加补充说明
- 周报统一存储在 `~/.weekly-reports/` 目录

## 使用方式

### 基本用法

在任意 Git 项目目录中执行：

```
/weekly-report
```

### 执行流程

1. **选择时间范围**
   - 本周 (显示具体日期，如 2026-01-06 ~ 2026-01-12)
   - 上周 (显示具体日期，如 2025-12-30 ~ 2026-01-05)
   - 前半年 (显示具体日期，如 2025-07-13 ~ 2026-01-13)
   - 自定义周报（输入周一日期）
   - 自定义时间段（输入起始日期，截止到今天）

   **重要**：
   - 所有日期计算必须使用 **中国时区 (UTC+8 / Asia/Shanghai)**，而不是系统默认时区
   - 选择时必须显示具体的日期范围，让用户确认是否正确

   **自定义日期输入规范（必须严格遵守）**：

   ⚠️ **严禁使用 AskUserQuestion 工具收集日期输入** ⚠️

   **问题原因**：AskUserQuestion 工具会将数字键识别为选项快捷键，导致用户输入 "2026-01-06" 时，按下 "2" 会被当作选择了选项 2，而不是日期的一部分。

   **使用场景区分**：
   | 场景 | 工具 | 用户操作 |
   |------|------|----------|
   | 选项选择（本周/上周/自定义等） | AskUserQuestion | 按数字快捷键或点击选项 |
   | 自由文本输入（日期、补充说明等） | 不使用任何工具，直接输出文本 | 输入内容后按 **Enter** 发送 |

   **正确流程**：
   1. 用 AskUserQuestion 显示时间范围选项（本周/上周/前半年/自定义周报/自定义时间段）
   2. 如果用户选择了"自定义周报"或"自定义时间段"：
      - **立即停止，不要调用任何工具**
      - 直接输出纯文本提示，例如："请输入周报的周一日期（格式：YYYY-MM-DD，如 2026-01-06）："
      - 等待用户在对话框中输入日期并按 Enter 发送

   **正确的交互示例**：
   ```
   第一步（使用 AskUserQuestion 工具选择选项）:
   [AskUserQuestion 工具显示选项]
   请选择时间范围：
   1. 本周 (2026-01-13 ~ 2026-01-19)
   2. 上周 (2026-01-06 ~ 2026-01-12)
   3. 前半年 (2025-07-19 ~ 2026-01-19)
   4. 自定义周报
   5. 自定义时间段

   用户选择: 4

   第二步（直接输出文本，不调用任何工具，等待用户回复）:
   Claude 直接输出文本: "请输入周报的周一日期（格式：YYYY-MM-DD，如 2026-01-06）："

   用户直接在对话框中输入: 2026-01-06
   [用户按 Enter 发送消息]
   ```

   **错误示例（严禁）**：
   ```
   # 错误：使用 AskUserQuestion 工具要求用户输入日期
   # 原因：用户按数字键会触发选项选择，无法正常输入日期
   AskUserQuestion({
     question: "请输入日期",
     options: [...]  // 这种方式无法让用户自由输入日期！
   })
   ```

2. **选择仓库**（如已配置多仓库）
   - 显示已配置的仓库列表
   - 可多选要包含的仓库
   - 可添加当前目录为新仓库

3. **添加补充内容**（可选）
   - 输入额外的工作内容
   - 如：参与会议、技术分享等

4. **生成周报**
   - 读取选定仓库的 Git 提交（必须覆盖所有分支/远端跟踪分支，避免漏提交）
   - 按项目分组
   - 过滤琐碎提交
   - 生成 Markdown 格式周报
   - 周报保存到 `~/.weekly-reports/{year}/week-{week}.md`
   - 时间段报告保存到 `~/.weekly-reports/periods/{start_date}_to_{end_date}.md`

## Git 提交读取（重要）

为避免"只读取当前分支而漏掉其它分支（例如 `credits-lite*`）"的问题，读取提交时必须使用 `--all`（覆盖本地分支 + 远端跟踪分支），并确保截止时间包含结束日当天：

```bash
# 关键点：
# - 用 --all 覆盖所有本地 refs（包含 remotes/origin/*）
# - --until 用 "结束日 23:59:59" 避免漏掉结束日当天提交
# - --author 建议用 name + email 联合匹配，避免不同身份写法漏掉本人提交
# - 必须使用中国时区 (UTC+8)

AUTHOR_PATTERN="(your-name|your@email.com)"  # 或仅用你的 name/email
TZ='Asia/Shanghai' git log --all \
  --author="$AUTHOR_PATTERN" \
  --since="$START_DATE 00:00:00" \
  --until="$END_DATE 23:59:59" \
  --pretty=format:"%H|%s|%an|%ad" \
  --date=short
```

### 日期计算（中国时区）

计算"本周"、"上周"等日期时，必须基于中国时区 (UTC+8)：

```bash
# 获取中国时区的当前日期
TODAY=$(TZ='Asia/Shanghai' date +%Y-%m-%d)

# 获取中国时区的星期几（1=周一, 7=周日）
DAY_OF_WEEK=$(TZ='Asia/Shanghai' date +%u)

# 计算本周一（中国时区）
THIS_MONDAY=$(TZ='Asia/Shanghai' date -v-$((DAY_OF_WEEK-1))d +%Y-%m-%d)

# 计算本周日（中国时区）
THIS_SUNDAY=$(TZ='Asia/Shanghai' date -v+$((7-DAY_OF_WEEK))d +%Y-%m-%d)
```

**注意**：所有显示给用户的日期都必须是中国时区的日期。

如果 `git branch -a` 看不到目标远端分支（说明本地没有对应的远端跟踪引用），需要先 `git fetch --all --prune`（在用户同意且网络可用时执行），否则无法读取到"本地不存在的分支"的提交。

### Commit Diff 分析（判断重点）

在总结前，必须通过 commit diff 判断工作重要性：

```bash
# 查看 commit 的改动规模
git show --stat <commit-hash>
```

**重点判断标准**：

| 条件 | 判定 | 处理方式 |
|------|------|----------|
| 改动文件数 > 5 或行数 > 100 | 重点工作 | 详细描述，保留子条目 |
| 涉及核心模块（auth, payment 等） | 重点工作 | 详细描述 |
| 有多次迭代/排查过程 | 难点工作 | 保留排查细节 |
| 只改 1-2 个文件且行数 < 20 | 普通工作 | 简略一句话 |
| 纯配置/样式微调 | 琐碎工作 | 过滤或合并 |

## 输出格式

周报采用层级列表结构，**必须包含日期范围标题**，按项目分组：

### 周报格式

```markdown
# 周报 (2026-01-06 ~ 2026-01-12)

项目名称
  - 主要工作点（10字以内）
    - 补充说明（可选）
  - 另一个工作点

其他
  - 不属于特定项目的工作内容
```

### 时间段报告格式

```markdown
# 工作总结 (2025-07-13 ~ 2026-01-13)

项目名称
  - 主要工作点（10字以内）
    - 补充说明（可选）
  - 另一个工作点

其他
  - 不属于特定项目的工作内容
```

### 示例输出

```markdown
# 周报 (2026-01-06 ~ 2026-01-12)

project-frontend
  - 跟进用户登录系统开发
    - 接口对接和联调
    - 表单验证优化
  - 认证流程问题排查修复
    - 排查后定位 token 过期问题
  - 构建工具升级

project-backend
  - 完成自定义消息渲染功能
    - 支持富文本和图片
  - 优化断线重连流程

其他
  - 新版国际化方案讨论
```

## 配置文件

配置文件位于 `~/.weekly-reports/config.json`：

```json
{
  "repos": [
    {
      "name": "project-a",
      "path": "/home/user/projects/project-a"
    },
    {
      "name": "project-b",
      "path": "/home/user/projects/project-b"
    }
  ],
  "default_author": "auto",
  "output_format": "markdown"
}
```

## 总结原则

### 必须遵守

- **事实导向**：只总结实际完成的工作
- **简洁精炼**：主要工作点控制在 10 字以内
- **重点突出**：过滤琐碎修改
- **按项目分组**：相同项目的工作归类
- **层级清晰**：用缩进表示从属关系
- **无标签风格**：不使用 [新功能]、[修复] 等标签，直接描述工作内容

### 输出约束（必须遵守）

| 约束项 | 限制 |
|--------|------|
| 每个主工作点 | 最多 2-3 个子条目 |
| 每个子条目 | 不超过 15 字 |
| 每个项目 | 最多 5-7 个主条目 |
| 修复类工作 | 除非是重大问题排查，否则不展开子条目 |

### 重点与难点体现

自动识别工作的重点和难点，通过内容详略体现（而非显式标记）：

- **重点工作**（改动规模大 + 多次迭代）：摘要更详细，保留 2-3 个子条目
- **难点工作**（多次尝试修复）：保留排查过程细节
- **普通工作**：简洁一句话，无子条目

**正确示例**（good.md 风格）：
```markdown
project-frontend
  - 跟进用户登录系统开发
    - 接口对接和联调
    - 表单验证优化
  - 认证流程问题排查修复
    - 排查后定位 token 过期问题
  - 构建工具升级
```

**错误示例**（禁止）：
```markdown
# 禁止：使用标签 + 子条目过多
  - [新功能] 用户登录系统开发
    - 接口对接和联调
    - 表单验证优化
    - 记住登录状态功能
    - 第三方登录集成

# 禁止：琐碎内容单独列出
  - [优化] 代码清理
  - [文档] 完善相关文档
```

### 过滤规则

#### 强制过滤（不输出）

以下提交不会单独列出：
- 代码清理、格式化、lint 修复
- 文档完善（除非是新文档或重大更新）
- 移除调试日志、console.log
- 样式微调（除非是设计系统变更）
- 依赖版本小幅更新
- 简单的 typo 修复
- Merge 提交

#### 合并处理（归类为一条）

- 同一功能的多个小改动 → 合并为一条功能描述
- 多个相关修复 → 合并为"问题排查修复"
- 重复性的相似提交 → 合并为一条

详细格式规范见 [周报格式规范](references/WEEKLY_REPORT_FORMAT.md)
